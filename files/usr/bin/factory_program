#!/bin/sh

if [ $# -eq 0 ]; then
	echo "Error, missing argument.  Please run with an option"
	echo "factory_program [enable|disable|status]"
	exit 1;
fi




option=$1


write_lock(){
	{
	dd if=/dev/mtd2 of=/tmp/factory.img
	printf "L" | dd conv=notrunc of=/tmp/factory.img obs=1 seek=28
	mtd write /tmp/factory.img factory
	} &> null;
}

write_unlock(){
	{
	dd if=/dev/mtd2 of=/tmp/factory.img
	printf "U" | dd conv=notrunc of=/tmp/factory.img obs=1 seek=28
	mtd write /tmp/factory.img factory
	} &> /dev/null
}


case "$option" in
enable)
	write_unlock
	;;
disable)
	write_lock
	;;
status)
	# Status signature in factory partitions
	s=$(dd if=/dev/mtd2 skip=28 bs=1 count=1 2> /dev/null)
	if [ "$s" == "U" ]; then 
		echo "enabled";
		exit 0;
	fi
	echo "disabled"
	exit 1;
	;;
*)
	echo "Invalid option."
	echo "factory_program [enable|disable|status]"
	exit 1;
esac;

exit 0;
