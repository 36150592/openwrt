#!/bin/sh

apn=$(uci get modem.@modem[0].apn)
if [[ -z "$apn" ]]; then
	apn=$(at.sh at+cgdcont? | sed -n '1p' | sed 's/"//g' | sed 's/,/ /g' | awk '{print $4}')
	uci set modem.@modem[0].apn=$apn
fi

while : 
do
	module=$(uci get system.@system[0].hostname)
	if [[ "$module" == "ER1000-VZ" ]]; then
		result=$(/usr/sbin/chat -V -t2 '' AT!GSTATUS? OK '' 2>&1 > /dev/ttyUSB2  < /dev/ttyUSB2)
		ifconfig eth1 | grep "inet addr"
		if [[ "$?" == "0" ]]; then
			uci set modem.@modem[0].status="Connected"
		else
			uci set modem.@modem[0].status="Disconnect"
		fi

		mode=$(echo $result | sed 's/^.*System mode\: //g' | sed 's/ *\^IPS.*$//g')
		if [[ "$mode" == "CDMA" ]]; then
			uci set modem.@modem[0].detectMode="3G"
		elif [[ "$mode" == "LTE" ]]; then
			uci set modem.@modem[0].detectMode="LTE"
		else
			uci set modem.@modem[0].detectMode=""
		fi

		rssi=$(echo $result | sed 's/^.*RSSI //g' | awk '{print$2}' | sed 's/ *\^I\^I.*$//g')
		uci set modem.@modem[0].rssi=$rssi

	else
		status=$(uqmi -d /dev/cdc-wdm0 --get-data-status | sed 's/\"//g')
		if [[ "$status" == "connected" ]]; then
			uci set modem.@modem[0].status="Connected"
		else
			uci set modem.@modem[0].status="Disconnect"
		fi

		mode=$(uqmi -d /dev/cdc-wdm0 --get-signal-info | grep type | awk '{print $2}' | sed -n '2p' | sed 's/ *",.*$//g' | sed 's/^.*"//g')
		if [[ "$mode" == "lte" ]]; then
			uci set modem.@modem[0].detectMode="LTE"
		else
			uci set modem.@modem[0].detectMode="3G"
		fi

		rssi=$(uqmi -d /dev/cdc-wdm0 --get-signal-info | grep rssi | awk '{print $2}' | sed -n '2p' | sed 's/ *,.*$//g')
		uci set modem.@modem[0].rssi=$rssi
	fi
	uci commit
	sleep 5
done